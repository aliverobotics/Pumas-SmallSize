using System;
using System.Drawing;
using System.Collections;
using System.Windows.Forms;
using System.Data;
using System.Net;
using System.Globalization;
using System.Threading;
using ZalSystem;
using Matrices;

namespace Gecko
{
	/// <summary>
	/// Summary description for Form1.
	/// </summary>
	public class Form1 : System.Windows.Forms.Form
	{
		private System.Windows.Forms.TextBox serverIPTextBox;
        private System.Windows.Forms.TextBox consoleTextBox;
		private System.Windows.Forms.Button startButton;
		private System.Windows.Forms.Label label2;
		
		private ZalRobot mrRoboto;			//Robot instance
		
		private UDPClientASocket clientSoc;	//Socket para recibir datos de vision
        private UDPClientASocket ctrlSoc;   //Socket para recibir comandos de control

        RobotDatos[] RobotsDatos;           //para los datos de todos robots
        //int TotalRobots;                 //total de robots detectados

        Pelota Balon;                       //Estructura para los datos del balon
        Cancha Field;                       //Estructura para los datos propios de la cancha
        String inMessageTMPCtrl;                //cadena temporal para verificar si llego la misma cadena
        String inMessageTMPVision;                //cadena temporal para verificar si llego la misma cadena
        Int32 MotorPower;                        //Max Potencia para los motores
        Int32 TurnPower;                    //Porcentaje durante giros
        Int32 FactorCorr;                   //Factor de correccion para los motores
        int behavior;
        bool goal,othergoal;
        bool reset;
        bool autoshoot;
        bool autoctrl;
        int target;
        bool shoot;
        bool stopped;
        bool pumas_team;
        bool going_left; //false for Pumas
        double   [] vel;  //izq der
        double[] data;  //new velovcitires
        double[] repulsion;

		#region Constants

        const int base10 = 10;
        char[] cHexa = new char[]{'A','B','C','D','E','F'};
        int[] iHexaNumeric = new int[] {10,11,12,13,14,15};
        int[] iHexaIndices = new int[] {0,1,2,3,4,5};
        const int asciiDiff = 48;

		private char	_charSPACE = ' ';
		private string	_strENTER = "\r\n";
		private char    _charNULL  = '\0';
		private System.Windows.Forms.TextBox sendPortTextBox;
		private System.Windows.Forms.Label sendPortLabel;
		private System.Windows.Forms.TextBox rcvPortTextBox;
        private System.Windows.Forms.Label rcvPortLabel;
        //private int		_intERROR = -1;
        private MainMenu mainMenu1;
        private TextBox rcvCtrlPortText;
        private Label label14;
        private TextBox sndCtrlPorttextbox;
        private Label label1;
        private ComboBox cboRobNum;
        private Label label15;
        private ComboBox cboPow;
        private Label label16;
        private Label label17;
        private ComboBox cboTurn;
        private Label label9;
        private Label label12;
        private Label label11;
        private Label lblBallX;
        private Label lblBallY;
        private ListBox lstListaRobots;
        private Label label3;
        private Label label4;
        private Label label5;
        private Label label6;
        private Label label7;
        private Label label8;
        private Label lblRobX;
        private Label lblRobY;
        private Label lblRobAng;
        private Label lblTeam;
        private Label lblRobNum;
        private TrackBar trkPow;
        private Label label10;
		
		private string[][] IPPortChart = {new string[]{"127.0.0.1"},
										  new string[]{"111", "8001", "8002", "ggp"},
										  new string[]{"112", "8003", "8004", "ggb"},
										  new string[]{"113", "8005", "8006", "gpb"},
										  new string[]{"114", "8007", "8008", "ppg"},
										  new string[]{"115", "8009", "8010", "ppb"}};
		#endregion

		public Form1()//constructor
		{
			//
			// Required for Windows Form Designer support
			//
			InitializeComponent();

			this.mrRoboto				= new ZalRobot();
			this.clientSoc				= new UDPClientASocket(System.Text.Encoding.ASCII);
            ctrlSoc                     = new UDPClientASocket(System.Text.Encoding.ASCII);
            
            behavior = 1;               //default:attack
            vel = new double[2] { 0, 0 };
            data = new double[2] { 0, 0 };
            repulsion = new double[2] { 0, 0 };

			InitIPPortGUI();
            
			this.clientSoc.DataReceived	+= new Gecko.UDPClientASocket.DataReceivedEventHandler(clientSoc_DataReceived);
			this.clientSoc.SocketClosed	+= new Gecko.UDPClientASocket.SocketClosedEventHandler(clientSoc_SocketClosed);
            ctrlSoc.SocketClosed += new Gecko.UDPClientASocket.SocketClosedEventHandler(clientSoc_SocketClosed);
            ctrlSoc.DataReceived += new Gecko.UDPClientASocket.DataReceivedEventHandler(ctrlSoc_DataReceived);
			
			this.KeyDown += new KeyEventHandler(Form1_KeyDown);

		}
		
		void InitIPPortGUI()
		{
			try
			{
				string myIP = clientSoc.GetMyIP().ToString();
				string[] temp = myIP.Split('.');
				string localNum = temp[temp.Length-1];
                this.Text = myIP;
				for(int n=0; n<IPPortChart.Length; n++)
				{
					if(localNum == IPPortChart[n][0])
					{
						if(n==0)
						{
							MessageBox.Show("No esta conectado a una red\r\n Se cerrara el programa");
							this.Close();
						}
						this.Text =  myIP;
						this.rcvPortTextBox.Text = IPPortChart[n][1];
						this.sendPortTextBox.Text = IPPortChart[n][2];
						break;
					}
				}
			}
			catch(Exception){
			}
		}

		/// <summary>
		/// Clean up any resources being used.
		/// </summary>
		///
		protected override void Dispose( bool disposing )
		{
			clientSoc.Close();
            ctrlSoc.Close();
			base.Dispose( disposing );
		}

		#region Windows Form Designer generated code
		/// <summary>
		/// Required method for Designer support - do not modify
		/// the contents of this method with the code editor.
		/// </summary>
		private void InitializeComponent()
		{
            this.sendPortTextBox = new System.Windows.Forms.TextBox();
            this.sendPortLabel = new System.Windows.Forms.Label();
            this.startButton = new System.Windows.Forms.Button();
            this.consoleTextBox = new System.Windows.Forms.TextBox();
            this.label2 = new System.Windows.Forms.Label();
            this.serverIPTextBox = new System.Windows.Forms.TextBox();
            this.rcvPortTextBox = new System.Windows.Forms.TextBox();
            this.rcvPortLabel = new System.Windows.Forms.Label();
            this.mainMenu1 = new System.Windows.Forms.MainMenu();
            this.rcvCtrlPortText = new System.Windows.Forms.TextBox();
            this.label14 = new System.Windows.Forms.Label();
            this.sndCtrlPorttextbox = new System.Windows.Forms.TextBox();
            this.label1 = new System.Windows.Forms.Label();
            this.cboRobNum = new System.Windows.Forms.ComboBox();
            this.label15 = new System.Windows.Forms.Label();
            this.cboPow = new System.Windows.Forms.ComboBox();
            this.label16 = new System.Windows.Forms.Label();
            this.label17 = new System.Windows.Forms.Label();
            this.cboTurn = new System.Windows.Forms.ComboBox();
            this.label9 = new System.Windows.Forms.Label();
            this.label12 = new System.Windows.Forms.Label();
            this.label11 = new System.Windows.Forms.Label();
            this.lblBallX = new System.Windows.Forms.Label();
            this.lblBallY = new System.Windows.Forms.Label();
            this.lstListaRobots = new System.Windows.Forms.ListBox();
            this.label3 = new System.Windows.Forms.Label();
            this.label4 = new System.Windows.Forms.Label();
            this.label5 = new System.Windows.Forms.Label();
            this.label6 = new System.Windows.Forms.Label();
            this.label7 = new System.Windows.Forms.Label();
            this.label8 = new System.Windows.Forms.Label();
            this.lblRobX = new System.Windows.Forms.Label();
            this.lblRobY = new System.Windows.Forms.Label();
            this.lblRobAng = new System.Windows.Forms.Label();
            this.lblTeam = new System.Windows.Forms.Label();
            this.lblRobNum = new System.Windows.Forms.Label();
            this.trkPow = new System.Windows.Forms.TrackBar();
            this.label10 = new System.Windows.Forms.Label();
            // 
            // sendPortTextBox
            // 
            this.sendPortTextBox.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.sendPortTextBox.Location = new System.Drawing.Point(54, 28);
            this.sendPortTextBox.Size = new System.Drawing.Size(56, 19);
            this.sendPortTextBox.Text = "8001";
            // 
            // sendPortLabel
            // 
            this.sendPortLabel.Font = new System.Drawing.Font("Microsoft Sans Serif", 6F, System.Drawing.FontStyle.Bold);
            this.sendPortLabel.ForeColor = System.Drawing.Color.White;
            this.sendPortLabel.Location = new System.Drawing.Point(0, 30);
            this.sendPortLabel.Size = new System.Drawing.Size(48, 21);
            this.sendPortLabel.Text = "VISION Snd Port:";
            // 
            // startButton
            // 
            this.startButton.Location = new System.Drawing.Point(197, 3);
            this.startButton.Size = new System.Drawing.Size(40, 21);
            this.startButton.Text = "Start";
            this.startButton.Click += new System.EventHandler(this.startButton_Click);
            // 
            // consoleTextBox
            // 
            this.consoleTextBox.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.consoleTextBox.Location = new System.Drawing.Point(0, 76);
            this.consoleTextBox.Multiline = true;
            this.consoleTextBox.ScrollBars = System.Windows.Forms.ScrollBars.Vertical;
            this.consoleTextBox.Size = new System.Drawing.Size(240, 33);
            // 
            // label2
            // 
            this.label2.Font = new System.Drawing.Font("Microsoft Sans Serif", 8.25F, System.Drawing.FontStyle.Bold);
            this.label2.ForeColor = System.Drawing.Color.White;
            this.label2.Location = new System.Drawing.Point(5, 3);
            this.label2.Size = new System.Drawing.Size(64, 16);
            this.label2.Text = "Remote IP:";
            // 
            // serverIPTextBox
            // 
            this.serverIPTextBox.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.serverIPTextBox.Location = new System.Drawing.Point(77, 3);
            this.serverIPTextBox.Size = new System.Drawing.Size(114, 19);
            this.serverIPTextBox.Text = "192.168.213.111";
            // 
            // rcvPortTextBox
            // 
            this.rcvPortTextBox.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.rcvPortTextBox.Location = new System.Drawing.Point(54, 52);
            this.rcvPortTextBox.Size = new System.Drawing.Size(56, 19);
            this.rcvPortTextBox.Text = "8011";
            // 
            // rcvPortLabel
            // 
            this.rcvPortLabel.Font = new System.Drawing.Font("Microsoft Sans Serif", 6F, System.Drawing.FontStyle.Bold);
            this.rcvPortLabel.ForeColor = System.Drawing.Color.White;
            this.rcvPortLabel.Location = new System.Drawing.Point(0, 52);
            this.rcvPortLabel.Size = new System.Drawing.Size(40, 21);
            this.rcvPortLabel.Text = "VISION Rcv Port:";
            // 
            // rcvCtrlPortText
            // 
            this.rcvCtrlPortText.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.rcvCtrlPortText.Location = new System.Drawing.Point(189, 52);
            this.rcvCtrlPortText.Size = new System.Drawing.Size(48, 19);
            this.rcvCtrlPortText.Text = "8234";
            // 
            // label14
            // 
            this.label14.Font = new System.Drawing.Font("Microsoft Sans Serif", 6F, System.Drawing.FontStyle.Bold);
            this.label14.ForeColor = System.Drawing.Color.White;
            this.label14.Location = new System.Drawing.Point(128, 52);
            this.label14.Size = new System.Drawing.Size(50, 21);
            this.label14.Text = "CTRL Snd Port:";
            // 
            // sndCtrlPorttextbox
            // 
            this.sndCtrlPorttextbox.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.sndCtrlPorttextbox.Location = new System.Drawing.Point(189, 28);
            this.sndCtrlPorttextbox.Size = new System.Drawing.Size(48, 19);
            this.sndCtrlPorttextbox.Text = "8123";
            // 
            // label1
            // 
            this.label1.Font = new System.Drawing.Font("Microsoft Sans Serif", 6F, System.Drawing.FontStyle.Bold);
            this.label1.ForeColor = System.Drawing.Color.White;
            this.label1.Location = new System.Drawing.Point(128, 28);
            this.label1.Size = new System.Drawing.Size(40, 21);
            this.label1.Text = "CTRL Rcv Port:";
            // 
            // cboRobNum
            // 
            this.cboRobNum.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.cboRobNum.Items.Add("0");
            this.cboRobNum.Items.Add("1");
            this.cboRobNum.Items.Add("2");
            this.cboRobNum.Items.Add("3");
            this.cboRobNum.Items.Add("4");
            this.cboRobNum.Location = new System.Drawing.Point(54, 112);
            this.cboRobNum.Size = new System.Drawing.Size(42, 20);
            this.cboRobNum.SelectedIndexChanged += new System.EventHandler(this.cboRobNum_SelectedIndexChanged);
            // 
            // label15
            // 
            this.label15.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label15.ForeColor = System.Drawing.Color.White;
            this.label15.Location = new System.Drawing.Point(3, 112);
            this.label15.Size = new System.Drawing.Size(56, 17);
            this.label15.Text = "RobNum";
            // 
            // cboPow
            // 
            this.cboPow.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.cboPow.Items.Add("0");
            this.cboPow.Items.Add("50");
            this.cboPow.Items.Add("100");
            this.cboPow.Items.Add("150");
            this.cboPow.Items.Add("200");
            this.cboPow.Items.Add("250");
            this.cboPow.Items.Add("300");
            this.cboPow.Items.Add("350");
            this.cboPow.Items.Add("400");
            this.cboPow.Items.Add("450");
            this.cboPow.Items.Add("500");
            this.cboPow.Items.Add("512");
            this.cboPow.Location = new System.Drawing.Point(196, 112);
            this.cboPow.Size = new System.Drawing.Size(41, 20);
            this.cboPow.SelectedIndexChanged += new System.EventHandler(this.cboPow_SelectedIndexChanged);
            // 
            // label16
            // 
            this.label16.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label16.ForeColor = System.Drawing.Color.White;
            this.label16.Location = new System.Drawing.Point(158, 112);
            this.label16.Size = new System.Drawing.Size(43, 18);
            this.label16.Text = "Power";
            // 
            // label17
            // 
            this.label17.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label17.ForeColor = System.Drawing.Color.White;
            this.label17.Location = new System.Drawing.Point(5, 139);
            this.label17.Size = new System.Drawing.Size(74, 20);
            this.label17.Text = "TurnPow(%)";
            // 
            // cboTurn
            // 
            this.cboTurn.Items.Add("0");
            this.cboTurn.Items.Add("20");
            this.cboTurn.Items.Add("40");
            this.cboTurn.Items.Add("60");
            this.cboTurn.Items.Add("80");
            this.cboTurn.Items.Add("100");
            this.cboTurn.Location = new System.Drawing.Point(73, 139);
            this.cboTurn.Size = new System.Drawing.Size(37, 22);
            this.cboTurn.SelectedIndexChanged += new System.EventHandler(this.cboTurn_SelectedIndexChanged);
            // 
            // label9
            // 
            this.label9.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label9.ForeColor = System.Drawing.Color.White;
            this.label9.Location = new System.Drawing.Point(9, 221);
            this.label9.Size = new System.Drawing.Size(101, 17);
            this.label9.Text = "Datos Pelota:";
            // 
            // label12
            // 
            this.label12.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label12.ForeColor = System.Drawing.Color.White;
            this.label12.Location = new System.Drawing.Point(0, 237);
            this.label12.Size = new System.Drawing.Size(25, 16);
            this.label12.Text = "X:";
            // 
            // label11
            // 
            this.label11.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label11.ForeColor = System.Drawing.Color.White;
            this.label11.Location = new System.Drawing.Point(0, 253);
            this.label11.Size = new System.Drawing.Size(25, 16);
            this.label11.Text = "Y:";
            // 
            // lblBallX
            // 
            this.lblBallX.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.lblBallX.ForeColor = System.Drawing.Color.White;
            this.lblBallX.Location = new System.Drawing.Point(17, 237);
            this.lblBallX.Size = new System.Drawing.Size(77, 13);
            // 
            // lblBallY
            // 
            this.lblBallY.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.lblBallY.ForeColor = System.Drawing.Color.White;
            this.lblBallY.Location = new System.Drawing.Point(17, 253);
            this.lblBallY.Size = new System.Drawing.Size(77, 13);
            // 
            // lstListaRobots
            // 
            this.lstListaRobots.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.lstListaRobots.Location = new System.Drawing.Point(5, 167);
            this.lstListaRobots.Size = new System.Drawing.Size(85, 54);
            this.lstListaRobots.SelectedIndexChanged += new System.EventHandler(this.lstListaRobots_SelectedIndexChanged);
            // 
            // label3
            // 
            this.label3.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label3.ForeColor = System.Drawing.Color.White;
            this.label3.Location = new System.Drawing.Point(142, 172);
            this.label3.Size = new System.Drawing.Size(95, 16);
            this.label3.Text = "Datos Robot:";
            // 
            // label4
            // 
            this.label4.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label4.ForeColor = System.Drawing.Color.White;
            this.label4.Location = new System.Drawing.Point(138, 188);
            this.label4.Size = new System.Drawing.Size(25, 16);
            this.label4.Text = "X:";
            // 
            // label5
            // 
            this.label5.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label5.ForeColor = System.Drawing.Color.White;
            this.label5.Location = new System.Drawing.Point(138, 204);
            this.label5.Size = new System.Drawing.Size(25, 16);
            this.label5.Text = "Y:";
            // 
            // label6
            // 
            this.label6.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label6.ForeColor = System.Drawing.Color.White;
            this.label6.Location = new System.Drawing.Point(125, 220);
            this.label6.Size = new System.Drawing.Size(34, 16);
            this.label6.Text = "Ang:";
            // 
            // label7
            // 
            this.label7.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label7.ForeColor = System.Drawing.Color.White;
            this.label7.Location = new System.Drawing.Point(107, 236);
            this.label7.Size = new System.Drawing.Size(56, 15);
            this.label7.Text = "Equipo:";
            // 
            // label8
            // 
            this.label8.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label8.ForeColor = System.Drawing.Color.White;
            this.label8.Location = new System.Drawing.Point(134, 251);
            this.label8.Size = new System.Drawing.Size(25, 16);
            this.label8.Text = "#:";
            // 
            // lblRobX
            // 
            this.lblRobX.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.lblRobX.ForeColor = System.Drawing.Color.White;
            this.lblRobX.Location = new System.Drawing.Point(157, 188);
            this.lblRobX.Size = new System.Drawing.Size(77, 13);
            // 
            // lblRobY
            // 
            this.lblRobY.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.lblRobY.ForeColor = System.Drawing.Color.White;
            this.lblRobY.Location = new System.Drawing.Point(157, 204);
            this.lblRobY.Size = new System.Drawing.Size(77, 13);
            // 
            // lblRobAng
            // 
            this.lblRobAng.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.lblRobAng.ForeColor = System.Drawing.Color.White;
            this.lblRobAng.Location = new System.Drawing.Point(157, 220);
            this.lblRobAng.Size = new System.Drawing.Size(77, 13);
            // 
            // lblTeam
            // 
            this.lblTeam.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.lblTeam.ForeColor = System.Drawing.Color.White;
            this.lblTeam.Location = new System.Drawing.Point(157, 236);
            this.lblTeam.Size = new System.Drawing.Size(77, 13);
            // 
            // lblRobNum
            // 
            this.lblRobNum.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.lblRobNum.ForeColor = System.Drawing.Color.White;
            this.lblRobNum.Location = new System.Drawing.Point(157, 251);
            this.lblRobNum.Size = new System.Drawing.Size(77, 13);
            // 
            // trkPow
            // 
            this.trkPow.LargeChange = 10;
            this.trkPow.Location = new System.Drawing.Point(146, 154);
            this.trkPow.Maximum = 100;
            this.trkPow.Size = new System.Drawing.Size(88, 15);
            this.trkPow.Value = 50;
            this.trkPow.ValueChanged += new System.EventHandler(this.trkPow_ValueChanged);
            // 
            // label10
            // 
            this.label10.Font = new System.Drawing.Font("Tahoma", 8F, System.Drawing.FontStyle.Regular);
            this.label10.ForeColor = System.Drawing.Color.White;
            this.label10.Location = new System.Drawing.Point(138, 140);
            this.label10.Size = new System.Drawing.Size(98, 14);
            this.label10.Text = "Cal. Potencia";
            // 
            // Form1
            // 
            this.BackColor = System.Drawing.Color.MediumSeaGreen;
            this.ClientSize = new System.Drawing.Size(240, 268);
            this.Controls.Add(this.label10);
            this.Controls.Add(this.trkPow);
            this.Controls.Add(this.cboTurn);
            this.Controls.Add(this.label17);
            this.Controls.Add(this.cboPow);
            this.Controls.Add(this.cboRobNum);
            this.Controls.Add(this.label16);
            this.Controls.Add(this.label15);
            this.Controls.Add(this.sndCtrlPorttextbox);
            this.Controls.Add(this.label1);
            this.Controls.Add(this.lstListaRobots);
            this.Controls.Add(this.rcvCtrlPortText);
            this.Controls.Add(this.label14);
            this.Controls.Add(this.lblBallY);
            this.Controls.Add(this.lblBallX);
            this.Controls.Add(this.lblRobNum);
            this.Controls.Add(this.lblTeam);
            this.Controls.Add(this.lblRobAng);
            this.Controls.Add(this.lblRobY);
            this.Controls.Add(this.lblRobX);
            this.Controls.Add(this.label11);
            this.Controls.Add(this.label12);
            this.Controls.Add(this.label9);
            this.Controls.Add(this.label8);
            this.Controls.Add(this.label7);
            this.Controls.Add(this.label6);
            this.Controls.Add(this.label5);
            this.Controls.Add(this.label4);
            this.Controls.Add(this.label3);
            this.Controls.Add(this.consoleTextBox);
            this.Controls.Add(this.startButton);
            this.Controls.Add(this.sendPortLabel);
            this.Controls.Add(this.sendPortTextBox);
            this.Controls.Add(this.label2);
            this.Controls.Add(this.serverIPTextBox);
            this.Controls.Add(this.rcvPortTextBox);
            this.Controls.Add(this.rcvPortLabel);
            this.ForeColor = System.Drawing.SystemColors.ActiveCaption;
            this.MaximizeBox = false;
            this.Menu = this.mainMenu1;
            this.MinimizeBox = false;
            this.Text = "Tracking UDP";
            this.Load += new System.EventHandler(this.Form1_Load);

		}
		#endregion

		/// <summary>
		/// The main entry point for the application.
		/// </summary>
		static void Main() 
		{
			Application.Run(new Form1());
		}

		private void startButton_Click(object sender, System.EventArgs e)
		{
			IgniteTerminal();
            mrRoboto.MyIdNum = 0;
            Field.anchoX=20;
            Field.largoY=20;
            
            Cte.Matrix = new double[,] { { -0.836, -0.718 }, { -0.99, 0.757 }, { -1.078, -0.883 } };
            Cte2.Matrix = new double[,] { { 0.17, -1.557 }, { -1.623, 0.017 }, { -0.211, -0.353 } };
            Cte3.Matrix = new double[,] { { -0.511, -0.518 }, { -1.811, 1.790 }, { -0.484, -0.492 } };
            Cte4.Matrix = new double[,] { { -0.029, -1.212 }, { -1.210, -0.034 }, { -0.115, -0.114 } };
		}

		private void IgniteTerminal()
		{
			mrRoboto.sPort.Open();
			startButton.Enabled = false;
			consoleTextBox.Text += "Waiting for connection..." + _strENTER;

			try
			{
				clientSoc.ConnectTo(serverIPTextBox.Text, Int32.Parse(sendPortTextBox.Text), Int32.Parse(rcvPortTextBox.Text));
                ctrlSoc.ConnectTo(serverIPTextBox.Text, Int32.Parse(sndCtrlPorttextbox.Text), Int32.Parse(rcvCtrlPortText.Text));
				consoleTextBox.Text += "Connected to VISION server @"
					+ sendPortTextBox.Text + _strENTER;
                consoleTextBox.Text += "Connected to CONTROL server @"
                    + sndCtrlPorttextbox.Text + _strENTER;
                consoleTextBox.Text += "Listening to VISION server @"
                    + rcvPortTextBox.Text + _strENTER;
                consoleTextBox.Text += "Listening to CONTROL server @"
                    + rcvCtrlPortText.Text + _strENTER;
                if (clientSoc.Connected && ctrlSoc.Connected)
                {
                    consoleTextBox.Text += "Vision AND Control connected\r\n";
                    clientSoc.WaitForData();
                    ctrlSoc.WaitForData();
                }
                else
                    consoleTextBox.Text += "Error al conectar a los servidores";
			}
			catch(Exception e234)
			{
				MessageBox.Show("Error while trying to connect:"+ _strENTER + e234.ToString());
				consoleTextBox.Text = e234.ToString();
				clientSoc.Close();
				startButton.Enabled = true;
			}
		}

		private void clientSoc_SocketClosed(object sender, SocketPack socPak)
		{
			consoleTextBox.Text += _strENTER + "Close Event occurred";
			clientSoc.Close();
			startButton.Enabled = true;
			consoleTextBox.Text = "";
		}
		
		string szDataV;
		private void clientSoc_DataReceived(object sender, SocketPack socPak)
		{
			try
			{
				szDataV = clientSoc.DecodeBytesToString(socPak.dataBuffer);
                //PartialVisionParsing(szDataV);
                if (!szDataV.Equals(inMessageTMPVision))
                {//no hacer nada si se recibe la misma cadena
                    ParseVisionData(szDataV);
                    inMessageTMPVision = szDataV;
                    Test_net(behavior);
                }
				clientSoc.WaitForData();
                
			}
			catch(System.NullReferenceException sne)
			{
				consoleTextBox.Text += "Error @ OnDataReceived NULL ref " + sne.ToString();
			}
			catch(System.Net.Sockets.SocketException)
			{
				consoleTextBox.Text = "Disconnected";
				clientSoc.Close();
			}
			catch (Exception ex)
			{
				consoleTextBox.Text += "Error @ OnDataReceived" + ex.ToString();
			}
		}
        /*
        private bool PartialVisionParsing(string inMessage)
        {
            String[] Token;
            String[] tmp;
            int j = 0;//contador auxiliar
            int i = 0;//contador aux
            int r = 0;//contador de robots
            bool parseerror = false;

            if (inMessage == null)
                return false;

            //First, we clean the message from those characters that we found useless
            inMessage = clientSoc.ReadUntil(inMessage, '\0'.ToString());
            inMessage = inMessage.TrimEnd(new char[] { _charSPACE, _charNULL });
            inMessage.ToUpper();
            consoleTextBox.Text += _strENTER + "VISION:" + inMessage;

            Token = inMessage.Split(new char[] { '\n', '\r', _charSPACE, _charNULL });

            #region TokensOK
            for (i = 0; i < Token.Length; i++)
            {//Contar cuantos NO nulos hay
                if (Token[i] != "")
                    j++;
            }
            tmp = new String[j];
            j = 0;
            for (i = 0; i < Token.Length; i++)
            {//Guardar sólo los NO nulos
                if (Token[i] != "")
                    tmp[j++] = Token[i];
            }

            Token = tmp;
            #endregion
            j = 0;//contador para token
            i = 0;//contador para robots

            
            if(Token[0].Equals("INFO")){
                //primero checar si ya existen los datos de ese robot para solo actualizarlos
                switch(Token[1]){
                    case "P"://pumas        INFO P ID X Y Vel Ang END
                        try
                        {
                            TotalRobots++;

                        }
                        catch (Exception)
                        {
                            consoleTextBox.Text = "Error while parsing";
                        }
                        break;
                    case "A"://contrario    INFO A X Y Vel END
                        try
                        {
                            TotalRobots++;
                        }
                        catch (Exception)
                        {
                            consoleTextBox.Text = "Error while parsing";
                        }
                        break;
                    case "B"://pelota       INFO B X Y Vel
                        try
                        {
                        }
                        catch (Exception)
                        {
                            consoleTextBox.Text = "Error while parsing";
                        }
                        break;
                }
            }
            else if(Token[0].Equals("FRAMEEND"))
                return true;
            return true;
        }
        */

        private double Normalize(double value, double m, double b)
        {
            double v = (float)0.0;
            //normalizing
            v = value*m+b;
            if (v > 1.0) v = (float)1.0;
            if (v < -1.0)v = (float)-1.0;
            return v;
        }

        Matriz Cte = new Matriz(3, 2);
        Matriz Cte2 = new Matriz(3, 2);
        Matriz Cte3 = new Matriz(3, 2);
        Matriz Cte4 = new Matriz(3, 2);

        private void Test_net(int behavior)
        {
            if (behavior>0)
            {
                //we test the net
                if (behavior == 1 && (mrRoboto.Dist2Ball > 10.0 || Math.Abs(mrRoboto.Ang2Ball) > 0.5))
                    Try_Net(2); //approach
                else
                    Try_Net(1);

                getRepulsion(target);
                data[0] += repulsion[0];
                data[1] += repulsion[1];
            }
            else
            {
                getRepulsion(target);
                data[0] = repulsion[0];
                data[1] = repulsion[1];

            }

            if (Math.Abs(data[0]-vel[0]) > 5 || Math.Abs(data[1]-vel[1]) > 5)
            {
                //we adjust new velocities
                vel[0] = data[0];
                vel[1] = data[1];

                if (FactorCorr < 50)
                    data[1] *= FactorCorr / (100.0 - FactorCorr);
                else
                    data[0] *= (100.0 - FactorCorr) / (FactorCorr);

                if (data[0] * data[1] < 0.0)
                { //turning
                    data[0] *= TurnPower / 100.0;
                    data[1] *= TurnPower / 100.0;
                }

                data[0] *= MotorPower;//generar velocidades
                data[1] *= MotorPower;

                //string o0 = data[0].ToString();
                //string o1 = data[1].ToString();

                /*consoleTextBox.Text += 
                    _strENTER + "INPUT NET ["+i0+","+i1+"] => ["+o0+","+o1+"]";*/

                string va0 = DecimalToBase(Math.Abs((Int32)data[0]), 16);
                string v0a = DecimalToBase(Math.Abs((Int32)data[1]), 16);

                va0 = CompleteString(va0);
                v0a = CompleteString(v0a);

                mrRoboto.sPort.WriteString("5da0" + getSigno(data[0]) + va0);//Vel Motor Izq
                Thread.Sleep(5);//necesario para que el micro responda
                mrRoboto.sPort.WriteString("5d0a" + getSigno(data[1]) + v0a);//Vel Motor Der
                Thread.Sleep(5);
            }            
        }

        private void getRepulsion(int target)
        {
            
        }

        private void Try_Net(int behavior)
        {
            Matriz Intel = new Matriz(1, 3);
            Matriz Intel2 = new Matriz(1, 3);

            Matriz V1 = null, V2 = null;

            double dist = Normalize(mrRoboto.Dist2Ball, 0.1, -1.0);
            double angle = Normalize(mrRoboto.Ang2Ball, 0.318471, 0.0);

            /*consoleTextBox.Text +=
               _strENTER + "[" + mrRoboto.Dist2Ball.ToString() + "," +
                            mrRoboto.Ang2Ball.ToString() + "] ---> " +
                            " Normalized [" + dist.ToString() + "," + angle.ToString() + "]";*/

            Intel.Matrix = new double[,] { { dist, angle, (double)1 } };


            //string i0 = Intel.Matrix[0, 0].ToString(); 
            //string i1 = Intel.Matrix[0, 1].ToString();
            switch (behavior)
            {
                case 1://attack
                    V1 = Intel.Multiplicar(Cte);
                    break;
                case 2://approach
                    V1 = Intel.Multiplicar(Cte3);
                    break;
            }

            if (V1 != null)//si se multiplico correctamente:
            {
                V1.TanSigMat();

                Intel2.Matrix[0, 0] = V1.Matrix[0, 0];
                Intel2.Matrix[0, 1] = V1.Matrix[0, 1];
                Intel2.Matrix[0, 2] = 1;
                switch (behavior)
                {
                    case 1://attack
                        V2 = Intel.Multiplicar(Cte2);
                        break;
                    case 2://approach
                        V2 = Intel.Multiplicar(Cte4);
                        break;
                }
                V2.TanSigMat();
            }

            data[0] = V2.Matrix[0, 0];//vels
            data[1] = V2.Matrix[0, 1];


        }

        private string CompleteString(string str)
        {
            string tmp = str;
            switch (str.Length)
            {
                case 0:
                    str = "0000";
                    break;
                case 1:
                    str = "000"+tmp;
                    break;
                case 2:
                    str = "00"+tmp;
                    break;
                case 3:
                    str = "0"+tmp;
                    break;
            }
            return str;
        }

        private string DecimalToBase(int iDec, int numbase)
        {
            string strBin = "";
            int[] result = new int[32];
            int MaxBit = 32;
            for(; iDec > 0; iDec/=numbase)
            {
                int rem = iDec % numbase;
                result[--MaxBit] = rem;
            } 
            for (int i=0;i<result.Length;i++)
                  if ((int) result.GetValue(i) >= base10)
                    strBin += cHexa[(int)result.GetValue(i)%base10];
                  else
                    strBin += result.GetValue(i);
            strBin = strBin.TrimStart(new char[] {'0'});
            return strBin;
        }
        /// <summary>
        /// Devuelve el valor necesario para generar la cadena RAW en el robot
        /// </summary>
        /// <param name="p">Valor (double) a verificar</param>
        /// <returns>"01": si el signo es +; "02",si es negativo;"00" si es 0</returns>
        private string getSigno(double p)
        {
            if (p > 0)
                return "01";
            else if (p < 0)
                return "02";
            else
                return "00";
        }

        /// <summary>
        /// Contiene los datos recibidos por el socket de control
        /// </summary>
        string szDataC;
        private void ctrlSoc_DataReceived(object sender, SocketPack socPak)
        {
            try
            {
                szDataC = ctrlSoc.DecodeBytesToString(socPak.dataBuffer);
                if (inMessageTMPCtrl != szDataC)
                {//para disminuir procesamiento innecesario, si se recibe la misma cadena
                    ParseCtrlData(szDataC);//Parseo de datos de ctrl
                    inMessageTMPCtrl = szDataC;
                }
                ctrlSoc.WaitForData();
            }
            catch (System.NullReferenceException sne)
            {
                consoleTextBox.Text += "Error @ OnDataReceivedCtrl NULL ref " + sne.ToString();
            }
            catch (System.Net.Sockets.SocketException)
            {
                consoleTextBox.Text = "Disconnected";
                ctrlSoc.Close();
            }
            catch (Exception ex)
            {
                consoleTextBox.Text += "Error @ OnDataReceivedCtrl" + ex.ToString();
            }
        }

        #region visionparsing
        
		/// <summary>
		/// Interpreta el mensaje enviado por visión y obtiene los datos de todos los robots
        /// que están en la cancha y los de la pelota
		/// </summary>
		/// <param name="inMessage">string to be parsed</param>
		/// <returns>nothing</returns>
		public void ParseVisionData(string inMessage)
		{
            String[] Token;
            String[] tmp;
            int j = 0;//contador auxiliar
            int i = 0;//contador aux
            int r=0;//contador de robots
            bool parseerror=false;
            
			if(inMessage == null)
				return;

			//First, we clean the message from those characters that we found useless
			inMessage = clientSoc.ReadUntil(inMessage, '\0'.ToString());
			inMessage = inMessage.TrimEnd(new char[]{_charSPACE, _charNULL});
            inMessage.ToUpper();
            //consoleTextBox.Text += _strENTER + "VISION:" + inMessage;

            Token = inMessage.Split(new char[]{'\n','\r',_charSPACE,_charNULL,','});

            #region TokensOK
            for (i = 0; i < Token.Length; i++)
            {//Contar cuantos NO nulos hay
                if (Token[i] != "")
                    j++;
            }
            tmp = new String[j];
            j = 0;
            for (i = 0; i < Token.Length; i++)
            {//Guardar sólo los NO nulos
                if (Token[i] != "")
                    tmp[j++] = Token[i];
                if(Token[i]=="INFO")
                    r++;//contar cuantos INFOS hay
            }

            Token = tmp;
            #endregion
            j = 0;//contador para token
            i = 0;//contador para robots

            RobotsDatos = new RobotDatos[r];
            r = 0;

            NumberFormatInfo numInfo=new NumberFormatInfo();
            numInfo.CurrencyDecimalSeparator = ".";
            numInfo.CurrencyGroupSeparator = ",";
            

            if (Token.Length > 1)
            {
                //if (Token[j++] == "FRAMESTART")
                //{
                try
                {
                    while (j < Token.Length)
                    {
                        while (Token[j++].Equals("INFO") && !parseerror && !Token[j].Equals("FRAMEEND"))
                        {
                            if (Token[j].Equals("P"))//pumas        INFO P ID X Y Vel Ang END
                            {
                                try
                                {
                                    RobotsDatos[i].Puma = true;
                                    RobotsDatos[i].RobNum = Int32.Parse(Token[++j], numInfo);
                                    RobotsDatos[i].posX = float.Parse(Token[++j], numInfo);
                                    RobotsDatos[i].posY = float.Parse(Token[++j], numInfo);
                                    RobotsDatos[i].Velocidad = float.Parse(Token[++j], numInfo);
                                    RobotsDatos[i].Angulo = float.Parse(Token[++j], numInfo);
                                    if (RobotsDatos[i].RobNum == mrRoboto.MyIdNum)
                                    {
                                        mrRoboto.X = RobotsDatos[i].posX;
                                        mrRoboto.Y = RobotsDatos[i].posY;
                                        mrRoboto.Angle = RobotsDatos[i].Angulo;
                                    }
                                    r++;
                                    if (RobotsDatos.Length - 1 > i)
                                        i++;
                                    if (!Token[++j].Equals("END"))
                                        parseerror = true;
                                }
                                catch (System.FormatException)
                                {
                                    //se recibio incorrectamente la cadena;
                                    //desechar el paquete recien recibido
                                    consoleTextBox.Text = _strENTER + "Error while parsing:" + Token[j - 1] + Token[j] + Token[j + 1] + _strENTER;
                                    parseerror = true;
                                }
                            }
                            else if (Token[j].Equals("A"))//contrario    INFO A X Y Vel END
                            {
                                try
                                {
                                    RobotsDatos[i].Puma = false;
                                    RobotsDatos[i].RobNum = Int32.Parse(Token[++j]);
                                    RobotsDatos[i].posX = float.Parse(Token[++j], numInfo);
                                    RobotsDatos[i].posY = float.Parse(Token[++j], numInfo);
                                    RobotsDatos[i].Velocidad = float.Parse(Token[++j], numInfo);
                                    RobotsDatos[i].Angulo = float.Parse(Token[++j], numInfo);
                                    r++;
                                    if (RobotsDatos.Length - 1 > i)
                                        i++;
                                    if (!Token[++j].Equals("END"))
                                        parseerror = true;
                                }
                                catch (System.FormatException)
                                {
                                    //se recibio incorrectamente la cadena;
                                    //desechar el paquete recien recibido
                                    consoleTextBox.Text = _strENTER + "Error while parsing:" + Token[j - 1] + Token[j] + Token[j + 1] + _strENTER;
                                    parseerror = true;
                                }
                            }
                            else if (Token[j].Equals("B"))
                            {
                                try
                                {
                                    Balon.posX = float.Parse(Token[++j], numInfo);
                                    Balon.posY = float.Parse(Token[++j], numInfo);
                                    Balon.Velocidad = float.Parse(Token[++j], numInfo);
                                    //Balon.Angulo = float.Parse(Token[++j]);
                                    if (!Token[++j].Equals("END"))
                                        parseerror = true;
                                }
                                catch (System.FormatException)
                                {
                                    //se recibio incorrectamente la cadena;
                                    //desechar el paquete recien recibido
                                    consoleTextBox.Text = _strENTER + "Error while parsing:" + Token[j - 1] + Token[j] + Token[j + 1] + _strENTER;
                                    parseerror = true;
                                }
                            }
                            else
                            {//ni jugador puma,enemigo o pelota: error
                                parseerror = true;
                                consoleTextBox.Text = _strENTER + "Error while parsing:" + Token[j - 1] + Token[j] + Token[j + 1] + _strENTER;
                            }
                            if (Token.Length - 1 > j && !parseerror)
                                j++;
                        }
                    }
                }
                catch (Exception)
                {
                    consoleTextBox.Text = "Incorrect DAta Received";
                }
                    //if (Token[j - 1] == "FRAMEEND" && i > 0 && !parseerror)
                    //{//se recibió la cadena correctamente

                GetData2Ball(mrRoboto);//obtener los datos a la pelota

                lstListaRobots.Items.Clear();
                //lblBallAng.Text = Balon.Angulo.ToString();
                //lblBallVel.Text = Balon.Velocidad.ToString();
                lblBallX.Text = Balon.posX.ToString();
                lblBallY.Text = Balon.posY.ToString();
                for (i = 0; i < r; i++)
                    lstListaRobots.Items.Add("Rob#" + RobotsDatos[i].RobNum.ToString());

                    //}
                //}
            }
            //else : error no se recibio una cadena correcta no hacer nada.
            return;
		}
#endregion

        /// <summary>
        /// Realiza las acciones enviada por el socket de control
        /// </summary>
        /// <param name="inMessage">Mensage que fue recibido en el socket</param>
        public void ParseCtrlData(string inMessage)
        {
            String [] Token;
            int i,j=0;

            if(inMessage==null)
                return;
            //First, we clean the message from those characters that we found useless
            inMessage = this.ctrlSoc.ReadUntil(inMessage, '\0'.ToString());
            inMessage = inMessage.TrimEnd(new char[] { _charSPACE, _charNULL });

            consoleTextBox.Text += _strENTER + "CONTROL:" + inMessage;
            inMessage.ToUpper();
            Token = inMessage.Split(new char[] { '\n', '\r', _charSPACE, _charNULL });

            #region TokensOK
            for (i = 0; i < Token.Length; i++)
            {//Contar cuantos NO nulos hay
                if (Token[i] != "")
                    j++;
            }
            String[] tmp = new String[j];
            j = 0;
            for (i = 0; i < Token.Length; i++)
            {//Guardar sólo los NO nulos
                if (Token[i] != "")
                    tmp[j++] = Token[i];
            }
            Token = tmp;
            #endregion
            
            switch (Token[0])
                {
                    case "robnum":
                        try
                        {
                            mrRoboto.MyIdNum = Int32.Parse(Token[2]);
                            consoleTextBox.Text = "ROBNUM:OK";
                        }
                        catch (System.FormatException)
                        {
                            consoleTextBox.Text += "ROBNUM:Failed";
                        }
                        break;
                    case "fielddim":
                        try
                        {
                            Field.anchoX = float.Parse(Token[2]);
                            Field.largoY = float.Parse(Token[3]);
                            consoleTextBox.Text = "FIELDDIM:OK";
                        }
                        catch (Exception)
                        {
                            consoleTextBox.Text += "FIELDDIM:Failed";
                        }
                        break;

                    case "attack":
                        behavior = 1;
                        break;
                    case "approach":
                        behavior = 2;
                        break;
                    case "evade":
                        behavior = 0;
                        break;
                    case "go":
                        stopped = false;
                        break;
                    case "reverse":
                        reverse();
                        break;
                    case "rotl":
                        rotatel();
                        break;
                    case "rotr":
                        rotater();
                        break;
                    case "reset":
                        reset=true;
                        break;
                    case "goal":
                        goal=true;
                        break;
                    case "othergoal":
				        othergoal = true;
                        break;
			        case "shooton":
				        shoot_on();
                        break;
                    case "shootoff":
				        shoot_off();
                        break;
                    case "youshoot":
				        autoshoot = true;
			            break;
                    case    "dontshootn":
				        autoshoot = false;
                        break;
                    case "takectrl":
        				autoctrl = true;
				        //printf ("Control taken !.\n");
			            break;
			        case "givectrl":
                        autoctrl = false;
				        //printf ("Control given to Clips !\n");
                        break;
                    case "target":
                        if (Token[1] == "b")
                            target = -1;
                        else
                        {
                            char[] tmp = Token[1].ToCharArray();
                            target = int.Parse(tmp);
                            if (Token[1].Substring(0,1) == "a") target += 5;
                        }
                        break;

                }
            
        }

        /// <summary>
        /// normaliza un angulo entre -pi y +pi
        /// </summary>
        public float normalizeAngle(float angle)
        {

            if (angle < -(float)Math.PI)
                angle += (float)(2.0 * Math.PI);

            if (angle >  (float)Math.PI)
                angle -= (float)(2.0 * Math.PI);

            return (angle);
        }

        /// <summary>
        /// funcion que devuelve el angulo de un vector en radianes
        /// </summary>
        public float Angulo(float VX, float VY)
        {
            if ((float)Math.Abs(VX) < (float)0.1 && (float)Math.Abs(VY) < (float)0.1) return 0;
            if (VX == (float)0)
                if (VY > (float)0)
                    return (float)Math.PI / (float)2.0; // pi/2 radianes = 90o
                else
                    return (float)1.5 * (float)Math.PI; //-pi / 2
            else
                if (VY == 0)
                    if (VX > 0)
                        return 0; // 0 radianes = 0o
                    else
                        return (float)Math.PI; //pi
                else
                {
                    double Theta = (float)Math.Atan(VY / VX);

                    if (VY < 0)
                        if (VX < 0)
                            return (float)Math.PI + (float)Theta; //3er cuadrante
                        else
                            return (float)2.0 * (float)Math.PI + (float)Theta; //4o cuadrante
                    else
                        if (VX < 0)
                            return (float)Math.PI + (float)Theta; //2o cuadrante
                        else
                            return (float)Theta; //1er cuadrante
                }
        }

        /// <summary>
        /// Convert from degrees to radians
        /// </summary>
        public float deg2rad(float deg)
        {
            return (deg * (float)Math.PI / (float)180.0);
        }

        /// <summary>
        /// Obtiene la distancia y el angulo del robot a la pelota
        /// y las pone en el objeto ZalRobot en las 
        /// respectivas variables
        /// </summary>
        public void GetData2Ball(ZalRobot Roboto)
        {//valores RAW
            //raw
            mrRoboto.Dist2Ball = (float)(Math.Abs(Math.Sqrt(Math.Pow(Roboto.X-Balon.posX, 2) + Math.Pow(Roboto.Y-Balon.posY, 2))));
         
            float Vx = (Balon.posX - Roboto.X);
            float Vy = (Balon.posY - Roboto.Y);
            float angulo_to_pel = Angulo(Vx, Vy);
            float angulo_robot = Roboto.Angle;
            //raw
            mrRoboto.Ang2Ball = normalizeAngle(angulo_to_pel-angulo_robot);
        }

        //------------------------------------------------------------------------------------
        //Function: ParseActionData
        //Purpose:  Parses the incoming string from sockets and executes an action
        //Accepts:	Message incoming from sockets
        //Returns:	Whether the string is acceptable in the established grammar
        //Throws:	
        //------------------------------------------------------------------------------------
        /// <summary>
        /// Parses a command string, and executes de command
        /// </summary>
        /// <param name="inMessage">string to be parsed</param>
        /// <returns>Parse success</returns>
        private string[] msgTokens;
        public void /*ExecList*/ ParseActionData(string inMessage)
        {
            //ExecList cmdRequest = new ExecList();

            //if (inMessage == null)
            //    return cmdRequest;

            //First, we clean the message from those characters that we found useless
            inMessage = clientSoc.ReadUntil(inMessage, '\n'.ToString());
            inMessage = inMessage.TrimEnd(new char[] { _charSPACE, _charNULL });

            //Second, we look for a command ID or the sender's IP
            if (inMessage.IndexOf("@") != -1)
            {
                msgTokens = inMessage.Split('@');

                try
                {
                    //cmdRequest.cmdID = int.Parse(msgTokens[1]);
                    inMessage = msgTokens[0];
                }
                catch (System.FormatException)
                {
                    try
                    {
                        if (msgTokens[1].Equals(clientSoc.ip.ToString()))
                        {
                            inMessage = msgTokens[0];
                        }
                    }
                    catch (System.FormatException)
                    {
                        //cmdRequest = new ExecList();
                        //return cmdRequest;
                    }
                }
            }

            //Clean the command submessage and divide in commandTokens
            inMessage = inMessage.ToLower();
            string[] commandTokens;
            inMessage = inMessage.TrimEnd(_charSPACE);
            commandTokens = inMessage.Split(_charSPACE);	//Our grammar divides commandTokens with space character

            int spaceCont = 0;
            for (int tokCont = 0; tokCont < commandTokens.Length; tokCont++)
            {
                if (commandTokens[tokCont] == "")
                    spaceCont++;
            }

            string[] finalTokens = new string[commandTokens.Length - spaceCont];
            int finalCont = 0;
            for (int tokCont = 0; tokCont < commandTokens.Length; tokCont++)
            {
                if (commandTokens[tokCont] != "")
                {
                    finalTokens[finalCont] = commandTokens[tokCont];
                    finalCont++;
                }
            }

            try
            {
                switch (finalTokens[0])
                {
                    //To Be Confirmed  commands (depends whether they are programmed on robot or not)
                    #region TBC Commands
                    //					case "hp":
                    //						break;
                    //					case "left":
                    //						mrRoboto.TurnLeft();
                    //						consoleTextBox.Text += "\r\nI'm here";
                    //						break;
                    //					case "right":
                    //						mrRoboto.TurnRight();
                    //						break;
                    //					case "forward":
                    //						mrRoboto.MoveForward();
                    //						break;
                    //					case "backward":
                    //						mrRoboto.MoveBackward();
                    //						break;
                    //					case "stop":
                    //						mrRoboto.Stop();
                    //						break;
                    //					case "raw":
                    //						if(commandTokens.Length > 1)
                    //						{
                    //							mrRoboto.sPort.WriteString(commandTokens[1]);
                    //							lastMessage = commandTokens[1];
                    //							messageSPort = commandTokens[1];
                    //						}
                    //						break;
                    //					case "setid":
                    //						if(commandTokens.Length>1)
                    //						{
                    //							mrRoboto.idNum = Int32.Parse(commandTokens[1]); 
                    //						}
                    //						break;
                    //					case "setsp":
                    //						if(commandTokens.Length > 1)
                    //						{
                    //							mrRoboto.SetSpeed(Int32.Parse(commandTokens[1]));
                    //						}
                    //						break;
                    //					case "shid":
                    //						if(clientSoc.clientSocket.Connected)
                    //						{
                    //							clientSoc.SendMsg(mrRoboto.idNum.ToString());
                    //						}
                    //						break;
                    //					case "shs":
                    //						if(commandTokens.Length>1)
                    //						{
                    //							clientSoc.SendMsg(mrRoboto.ReqSensorVal(commandTokens[1], Int32.Parse(commandTokens[2])));
                    //						}
                    //						break;
                    //					case "bye":
                    //						throw new Exception("Call to end program");
                    #endregion
                    case "mv":
                        if (finalTokens.Length > 2)
                        {
                            try
                            {
                                //cmdRequest.mvReq = true;
                                //cmdRequest.mvDist = float.Parse(finalTokens[1], System.Globalization.NumberStyles.Float);
                                //cmdRequest.mvAngle = float.Parse(finalTokens[2], System.Globalization.NumberStyles.Float);
                                consoleTextBox.Text += _strENTER + "Moving Robot";
                                mrRoboto.TurnAndMove(float.Parse(finalTokens[1], System.Globalization.NumberStyles.Float), float.Parse(finalTokens[2], System.Globalization.NumberStyles.Float));
                            }
                            catch (System.Exception se)
                            {
                                consoleTextBox.Text += "Error:" + se +_strENTER;
                            }
                        }
                        break;
                    case "raw"://new
                        if (finalTokens[1].Length == 10)
                            mrRoboto.sPort.WriteString(finalTokens[1]);
                        this.consoleTextBox.Text += finalTokens[1] + "\r\n";
                        break;
                    case "shooton":
                        {
                            consoleTextBox.Text += _strENTER + "Activating Shooter...";
                            mrRoboto.ShootOn();
                            //mainCmdRequest.shOnReq = false;
                            Thread.Sleep(100);
                        }
                        break;
                    case "shootoff":
                        {
                            consoleTextBox.Text += _strENTER + "Deactivating Shooter...";
                            mrRoboto.ShootOff();
                            //mainCmdRequest.shOffReq = false;
                            Thread.Sleep(100);
                        }
                        break;
                    default: break;
                }

            }
            catch (Exception excp)
            {
                consoleTextBox.Text += _strENTER + "Error while Parsing."
                    + _strENTER + excp.ToString();
                //cmdRequest = new ExecList();
            }
            //return cmdRequest;
        }


		/// <summary>
		/// When the ENTER button is pressed on the ppc, 
		/// Application tries to connect to server
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="e"></param>
		private void Form1_KeyDown(object sender, KeyEventArgs e)
		{
			if(e.KeyCode == Keys.Return && startButton.Enabled == true)
				IgniteTerminal();
		}

		private void clearButton_Click(object sender, System.EventArgs e)
		{
			//countLabel.Text = commandCount.ToString();
            consoleTextBox.Text = "";
		}

        private void menuItem1_Click(object sender, EventArgs e)
        {
            //this.Close();
            //clientSoc.Close();
        }

        private void lstListaRobots_SelectedIndexChanged(object sender, EventArgs e)
        {
            int i = lstListaRobots.SelectedIndex;

            lblRobAng.Text = RobotsDatos[i].Angulo.ToString();
            lblRobNum.Text = RobotsDatos[i].RobNum.ToString();
            lblRobX.Text = RobotsDatos[i].posX.ToString();
            lblRobY.Text = RobotsDatos[i].posY.ToString();

            if (RobotsDatos[i].Puma)
                lblTeam.Text = "Pumas";
            else
                lblTeam.Text = "Contrario";
        }

        private void Form1_Load(object sender, EventArgs e)
        {

        }

        private void cboRobNum_SelectedIndexChanged(object sender, EventArgs e)
        {
            mrRoboto.MyIdNum = Int32.Parse(cboRobNum.Text);
        }

        private void cboPow_SelectedIndexChanged(object sender, EventArgs e)
        {
            MotorPower = Int32.Parse(cboRobNum.Text);
        }

        private void cboTurn_SelectedIndexChanged(object sender, EventArgs e)
        {
            TurnPower = Int32.Parse(cboTurn.Text); 
        }

        private void trkPow_ValueChanged(object sender, EventArgs e)
        {
            FactorCorr = trkPow.Value;
        }


        private void shoot_on ()
        {
	        if (shoot==true) return;
            mrRoboto.ShootOn();
	        shoot = true;
        }

        private void shoot_off ()
        {
	        if (shoot==false) return;
            mrRoboto.ShootOff();
	        shoot = false;
        }

        void reverse()
	    {
            stop();
            mrRoboto.sPort.WriteString("5da00100ff");
            Thread.Sleep(5);
            mrRoboto.sPort.WriteString("5d0a0100ff");
            vel[0] = -255;
            vel[1] = -255;
	    }

        void stop()
	    {
		    stopped = true;
            mrRoboto.sPort.WriteString("5da0000000");
            Thread.Sleep(5);
            mrRoboto.sPort.WriteString("5d0a000000");
		    vel[0] = 0.0;
		    vel[1] = 0.0;
	    }
        void rotatel()
	    {
		    stop();
            mrRoboto.sPort.WriteString("5da00100ff");
            Thread.Sleep(5);
            mrRoboto.sPort.WriteString("5d0a0000ff");
		    vel[0] = -255;
		    vel[1] = +255;
	    }

	    void rotater()
	    {
            stop();
            mrRoboto.sPort.WriteString("5d0a0100ff");
            Thread.Sleep(5);
            mrRoboto.sPort.WriteString("5da00000ff");
		    vel[0] = +255;
		    vel[1] = -255;
	    }
	}
}